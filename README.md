## 🚀 실행 방법

### 애플리케이션 실행

루트 디렉토리에서 아래 명령어를 실행하여 모든 서비스(Gateway, Auth, Event 서버 및 MongoDB, Redis)를 한 번에 빌드하고 실행할 수 있습니다.

```bash
docker compose up --build
```

<br>

### 스웨거(Swagger) 주소

애플리케이션이 실행된 후, Gateway 서버의 스웨거 문서는 다음 주소에서 접근할 수 있습니다.

- **스웨거 UI**: [http://localhost:3000/swagger](http://localhost:3000/swagger)
- API Dto description를 통해 각각의 인자들이 어떤 역할을 하는 인자인지 파악할 수 있습니다.

<br>

### 전체적인 진행 플로우
- 유저가 보상 요청 플로우
```
이벤트 목록 조회 -> 특정 이벤트로 상세 조회 -> 내 활동 내역에 만족하는 이벤트 상세 Id로 보상 요청
```
- 관리자가 이벤트 생성 플로우
```
보상 생성 -> 이벤트 생성 -> 생성한 이벤트에 보상과 조건을 포함한 이벤트 상세 생성
```

<br>

## ✨ 테스트 데이터 셋 설명

스웨거의 **테스트 관련 API** 중 `/make-data-set[POST]` 엔드포인트를 통해 각 역할(Role)에 해당하는 유저 및 미리 정의된 이벤트, 보상 데이터를 쉽게 생성할 수 있습니다. 

시스템의 다양한 기능을 테스트하는 데 필요한 초기 데이터를 제공할 수 있습니다.

<details>
  <summary>데이터 셋 미리보기</summary>  
  
  ### 🧑‍💻 유저 정보 (생성되는 유저 계정)
`/make-data-set` API를 통해 생성되는 기본 유저 계정 정보입니다.

- **ADMIN**: 모든 기능에 접근 가능 (USER 전용 API 제외)
    - `id`: `admin@admin.com`
    - `password`: `1234`
- **OPERATOR**: 이벤트 및 보상 등록 가능
    - `id`: `operator@operator.com`
    - `password`: `1234`
- **AUDITOR**: 이벤트 및 보상 내역 조회만 가능
    - `id`: `auditor@auditor.com`
    - `password`: `1234`
- **USER**: 보상 요청 가능
    - `id`: `user@user.com`
    - `password`: `1234`

### 🗓️ 이벤트 목록 (생성되는 이벤트)

`/make-data-set` API를 통해 생성되는 주요 이벤트 유형 및 조건은 다음과 같습니다.

- **출석 이벤트**
    - 2025-05-20 출석 시 아이템 지급
    - 2025-05-21 출석 시 아이템 지급
    - 2025-05-22 출석 시 아이템 지급
    - 2025-05-23 출석 시 아이템 지급
    - 2025-05-24 출석 시 아이템 지급
    - 2025-05-25 출석 시 아이템 지급
    - 2025-05-26 ~ 2025-05-30 출석 시 아이템 지급
    - 누적 5일 출석 시 아이템 지급
    - 누적 10일 출석 시 아이템 지급
- **PC방 이용 이벤트**
    - 2025-05-20 일일 PC방 이용 시간 60분 이상 시 아이템 지급
    - 누적 PC방 이용 시간 300분 이상 시 아이템 지급
- **몬스터 처치 이벤트**
    - 2025-05-20 일일 몬스터 처치 수 100 이상 시 경험치 쿠폰 지급
    - 2025-05-21 일일 몬스터 처치 수 200 이상 시 경험치 쿠폰 지급
    - 2025-05-22 일일 몬스터 처치 수 300 이상 시 경험치 쿠폰 지급
- **캐시 충전 이벤트**
    - 누적 캐시 100,000원 이상 시 포인트 지급
    - 누적 캐시 200,000원 이상 시 포인트 지급
- **페이지 방문 이벤트**
    - 넥슨 페이지 방문 시 쿠폰 지급

### 🎁 보상 목록 (생성되는 보상 유형)

`/make-data-set` API를 통해 생성되는 보상 유형은 다음과 같습니다.

- **캐시 포인트**
- **아이템**: 경험치 쿠폰, 다양한 종류의 장비 아이템 등
- **할인 쿠폰**
    
</details>

<br>

## 💡 이벤트 조건 검증을 위한 유저 활동 데이터

- **이벤트/보상 관리 플랫폼 구축**이라는 목표에 따라 이벤트 시스템의 설계와 조건 검증 로직 구현에 집중했습니다
- 이에 따라 유저의 실시간 활동 정보를 수집하고 이를 실제 비즈니스 로직과 직접 연동하는 로직은 이번 과제의 범위에서 제외했습니다.
- 이벤트 조건 검증 로직이 실제 유저 데이터에 기반하여 올바르게 동작하는지 확인하기 위해 **각각의 유저 활동 정보 테이블을 테스트 목적으로 구현했습니다.**
- **각각의 유저 활동 정보 테이블**은 유저의 출석, PC방 이용 시간, 몬스터 처치 수, 캐시 충전, 페이지 방문 기록 등 다양한 활동을 시뮬레이션하는 데 사용하고 있습니다.

  <details>
  
    <summary>유저 활동 데이터 조작 방법</summary>  
    <br>
  
    **테스트 관련 API를 통해 각각의 유저 활동 데이터를 스웨거에서 편하게 생성할 수 있습니다.**
    
  - **게임 접속 정보 (Access Game Information)**
      - POST 요청을 통해 접속한 날짜를 'yyyy-mm-dd' 형식으로 입력하여 데이터를 생성할 수 있습니다.
      - 당일 누적 이용 시간 및 당일 누적 PC방 이용 시간은 PATCH 요청을 통해 변경할 수 있습니다. (PATCH 요청 시 해당 컬럼 ID가 필요합니다.)
      - 또한, 패스권 개념을 도입하여 지난 날짜도 출석체크가 가능하도록 설계했습니다. (로직적인 예외 처리는 테스트 목적이므로 포함하지 않았습니다.)
  
  - **몬스터 처치 횟수 (Daily Monster Kill)**
      - POST 요청을 통해 접속한 날짜를 'yyyy-mm-dd' 형식으로 입력하여 데이터를 생성할 수 있습니다.
      - 당일 몬스터 처치 횟수는 PATCH 요청을 통해 변경할 수 있습니다. (PATCH 요청 시 해당 컬럼 ID가 필요합니다.)
  
  - **결제 내역 (Purchase History)**
      - POST 요청을 통해 결제 금액을 입력하여 내역을 생성할 수 있습니다.
      - `isPaid` 필드를 통해 이벤트로 받은 금액인지 실제 결제 금액인지 구별할 수 있도록 했습니다.
  
  - **페이지 방문 정보 (Page Visit)**
      - POST 요청을 통해 방문한 페이지 URL을 입력하여 내역을 생성할 수 있습니다.
  
  </details>

<br>

## 🧐 구현 중 겪은 고민

프로젝트를 진행하며 마주했던 주요 고민들과 그에 대한 접근 방식입니다.

- **외부 서비스 통신 오류로 인한 데이터 정합성 문제**:
    - 외부 서비스 호출 시 네트워크 문제 등으로 인해 정상적으로 처리되었음에도 응답을 받지 못하는 경우에 대한 고민이 있었습니다.
    - 예를 들어, Event 서버가 보상 지급을 위해 Auth 서버를 호출하고, Auth 서버가 보상을 성공적으로 지급했으나 네트워크 오류로 Event 서버에 응답을 주지 못한다면, Event 서버는 해당 작업의 성공/실패 여부를 알 수 없습니다.
    - 이러한 상황을 방지하고자 Auth 서버에서는 성공 시 반드시 성공 데이터를 저장하도록 구현했습니다.
    - 만일 통신 오류가 발생하더라도 Event 서버는 `catch` 블록 내에서 Auth 서버에 해당 작업의 최종 상태를 재확인하고, 그 결과에 따라 사후 처리를 할 수 있도록 설계했습니다.
- **복잡한 이벤트 구조 설계**:
    - 출석 이벤트와 같이 하나의 이벤트 내에 여러 보상 조건이 복합적으로 얽혀 있을 경우, 이를 어떻게 유연하고 확장성 있게 구조화할지에 대한 고민이 있었습니다.
    - 이 문제를 해결하기 위해 이벤트를 **2단계 구조**로 구현했습니다.
        - **이벤트**: 이벤트명, 시작일, 마감일, 활성화 여부 등 모든 이벤트에 공통되는 기본 정보만 저장합니다.
        - **이벤트 상세**: 각 이벤트의 개별 지급 조건, 보상 내용, 수량 등을 저장합니다. 이를 통해 하나의 이벤트가 다양한 조건과 여러 종류의 보상을 포함할 수 있도록 유연성을 확보했습니다.

<br>

## 🚧 한계 및 개선 방안

현재 프로젝트의 한계점과 향후 개선이 필요하다고 판단되는 부분들입니다.

- **테스트 코드의 미완성**:
    - 현재 **이벤트 조건 검증 로직**에 대해서만 테스트 코드를 구현했습니다.
    - 조건 검증 로직을 제외한 대부분의 기능에 대한 테스트 코드는 아직 미흡한 점이 있습니다.
- **단시간 대규모 트래픽 처리**:
    - 이벤트 시작 등 특정 시점에 단시간 내 대규모 트래픽이 발생할 경우, 시스템의 안정적인 처리와 성능 보장에 대한 추가적인 대책이 필요할 거 같습니다.
    - 이런 상황에서는 Kafka와 같이 안정적인 메시지 큐(Queue) 시스템으로 구조를 변경하고, 보상 지급과 같은 외부 API 호출이 필요한 작업을 큐에서 비동기적으로 처리한다면 유저에게 즉각적인 반응을 제공하기는 어렵겠지만, 트래픽을 훨씬 안전하고 효율적으로 처리할 수 있을 것 같습니다.
- **데이터 정합성 불일치 발생 가능성**:
    - 예기치 않은 서버 장애나 외부 시스템 문제 등 불특정한 상황에서 이벤트 보상 지급 시, 실제로는 지급되었음에도 불구하고 시스템에는 실패로 기록될 수 있는 잠재적인 데이터 정합성 문제가 발생할 수 있습니다.
    - 예를 들어, Auth 서버가 유저 스키마에 보상을 반영한 후 해당 작업에 대한 성공 데이터를 최종적으로 저장하기 전에 서버가 갑자기 종료된다면, 실제 보상은 지급되었지만 Event 서버는 물론 Auth 서버 자체도 이 상태를 정확히 인지하지 못하는 상황이 발생할 수 있습니다.
- **세부적인 예외처리 미흡**:
    - 비즈니스 로직 내의 모든 잠재적 예외 상황에 대한 세분화된 예외 처리 및 클라이언트에게 반환될 에러 응답 정의가 아직 미흡합니다.